(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();var N={exports:{}};(function(h){var e=Object.prototype.hasOwnProperty,t="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(t=!1));function n(r,o,a){this.fn=r,this.context=o,this.once=a||!1}function i(){this._events=new s,this._eventsCount=0}i.prototype.eventNames=function(){var o=[],a,l;if(this._eventsCount===0)return o;for(l in a=this._events)e.call(a,l)&&o.push(t?l.slice(1):l);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(a)):o},i.prototype.listeners=function(o,a){var l=t?t+o:o,c=this._events[l];if(a)return!!c;if(!c)return[];if(c.fn)return[c.fn];for(var u=0,f=c.length,g=new Array(f);u<f;u++)g[u]=c[u].fn;return g},i.prototype.emit=function(o,a,l,c,u,f){var g=t?t+o:o;if(!this._events[g])return!1;var d=this._events[g],p=arguments.length,v,m;if(d.fn){switch(d.once&&this.removeListener(o,d.fn,void 0,!0),p){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,a),!0;case 3:return d.fn.call(d.context,a,l),!0;case 4:return d.fn.call(d.context,a,l,c),!0;case 5:return d.fn.call(d.context,a,l,c,u),!0;case 6:return d.fn.call(d.context,a,l,c,u,f),!0}for(m=1,v=new Array(p-1);m<p;m++)v[m-1]=arguments[m];d.fn.apply(d.context,v)}else{var F=d.length,P;for(m=0;m<F;m++)switch(d[m].once&&this.removeListener(o,d[m].fn,void 0,!0),p){case 1:d[m].fn.call(d[m].context);break;case 2:d[m].fn.call(d[m].context,a);break;case 3:d[m].fn.call(d[m].context,a,l);break;case 4:d[m].fn.call(d[m].context,a,l,c);break;default:if(!v)for(P=1,v=new Array(p-1);P<p;P++)v[P-1]=arguments[P];d[m].fn.apply(d[m].context,v)}}return!0},i.prototype.on=function(o,a,l){var c=new n(a,l||this),u=t?t+o:o;return this._events[u]?this._events[u].fn?this._events[u]=[this._events[u],c]:this._events[u].push(c):(this._events[u]=c,this._eventsCount++),this},i.prototype.once=function(o,a,l){var c=new n(a,l||this,!0),u=t?t+o:o;return this._events[u]?this._events[u].fn?this._events[u]=[this._events[u],c]:this._events[u].push(c):(this._events[u]=c,this._eventsCount++),this},i.prototype.removeListener=function(o,a,l,c){var u=t?t+o:o;if(!this._events[u])return this;if(!a)return--this._eventsCount===0?this._events=new s:delete this._events[u],this;var f=this._events[u];if(f.fn)f.fn===a&&(!c||f.once)&&(!l||f.context===l)&&(--this._eventsCount===0?this._events=new s:delete this._events[u]);else{for(var g=0,d=[],p=f.length;g<p;g++)(f[g].fn!==a||c&&!f[g].once||l&&f[g].context!==l)&&d.push(f[g]);d.length?this._events[u]=d.length===1?d[0]:d:--this._eventsCount===0?this._events=new s:delete this._events[u]}return this},i.prototype.removeAllListeners=function(o){var a;return o?(a=t?t+o:o,this._events[a]&&(--this._eventsCount===0?this._events=new s:delete this._events[a])):(this._events=new s,this._eventsCount=0),this},i.prototype.off=i.prototype.removeListener,i.prototype.addListener=i.prototype.on,i.prototype.setMaxListeners=function(){return this},i.prefixed=t,i.EventEmitter=i,h.exports=i})(N);var k=N.exports;function O(h,e=!1){return new Promise((t,s)=>{var n=new XMLHttpRequest;n.open("GET",h,!0),n.onload=function(i){let r=null;if(n.status==200){try{e?r=n.response.split(`
`).map(a=>JSON.parse(a)):r=JSON.parse(n.response),t(r)}catch(o){s(`Failed to parse JSON at ${h}: ${o}.`)}t(r)}else s(`Failed statusCode: ${n.status}.`)},n.send()})}function $(h){let e={x:1/0,y:1/0},t={x:-1/0,y:-1/0};for(let s of h){for(let n of s[0])n<e.x&&(e.x=n),n>t.x&&(t.x=n);for(let n of s[1])n<e.y&&(e.y=n),n>t.y&&(t.y=n)}return new w(e.x,e.y,t.x-e.x,t.y-e.y)}function D(h){let e=Math.floor(Math.random()*h.length);return h[e]}class w{constructor(e,t,s,n){this.x=e,this.y=t,this.width=s,this.height=n}multiply(e,t){return new w(this.x*e,this.y*t,this.width*e,this.height*t)}pad(e,t){return new w(this.x-e,this.y-t,this.width-2*e,this.height-2*t)}left(){return this.x}top(){return this.y}bottom(){return this.y+this.height}right(){return this.x+this.width}intersects(e){return this.left()<=e.right()&&e.left()<=this.right()&&this.top()<=e.bottom()&&e.top()<=this.bottom()}static copy(e){return new w(e.x,e.y,e.width,e.height)}}class S{constructor(e,t){this.x=e,this.y=t}scale(e,t){let s=new S(this.x,this.y);return s.x*=e,s.y*=t,s}}class M extends k.EventEmitter{constructor(e){super(),this.canvas=document.querySelector(e),this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px"}clear(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}setTargetRect(e){this.targetRect=e}renderLines(e){let t=this.canvas.getContext("2d");t.lineCap="round",t.lineWidth=2,t.strokeStyle=this.strokeStyle;for(let s of e){t.beginPath(),this.emit("down");for(let n of s){let i=(this.targetRect.x+n.x*this.targetRect.width)*this.canvas.width,r=(this.targetRect.y+n.y*this.targetRect.height)*this.canvas.height;t.lineTo(i,r),this.emit("position",new S(i,r))}t.stroke(),this.emit("up")}}renderDrawRect(){let e=this.canvas.getContext("2d"),t=this.targetRect.multiply(this.canvas.width,this.canvas.height);e.rect(t.x,t.y,t.width,t.height),e.lineWidth=2,e.strokeStyle="red",e.setLineDash([]),e.stroke()}finish(){}getCanvasElement(){return this.canvas}setStrokeStyle(e){this.strokeStyle=e}}class W{constructor(e){let t=document.querySelector(e.selector);t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this)),t.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mouseout",this.onMouseOut.bind(this)),t.style.display="block",this.renderer=e.renderer}onMouseDown(e){this.renderer.lowerPen()}onMouseMove(e){let t=e.offsetX/e.target.offsetWidth,s=e.offsetY/e.target.offsetHeight;this.renderer.isLowered&&(console.log(`Setting position to (${t}, ${s}).`),this.renderer.setPosition(t*100,s*100).then(n=>{console.log("Position set successfully!")}))}onMouseUp(e){this.renderer.raisePen()}onMouseOut(e){console.log("onMouseOut_")}}const Q="http://localhost:8080/v1/pen",U={width:138,height:67};class H{constructor(e){this.canvasDimensions=e.canvasDimensions||U,this.isLowered=void 0,this.raisePen(),this.commandQueue=[]}renderLines(e){this.queueCommand(this.raisePen);for(let t of e){let s=!0;for(let n of t){let i=(n.x-this.bounds.x)/this.bounds.width,r=(n.y-this.bounds.y)/this.bounds.height;console.log(`Drawing point at (${i}, ${r}).`),i*=.1,r*=.1,this.queueCommand(this.setPosition,i*100,r*100),s&&(this.queueCommand(this.lowerPen),s=!1)}this.queueCommand(this.raisePen)}}finish(){console.log("Drawbot rendering complete!"),this.queueCommand(this.setPosition,0,0),this.queueCommand(this.unlockMotors)}unlockMotors(){return fetch("http://localhost:8080/v1/motors",{method:"DELETE"})}setBounds(e){console.log(`Setting bounds to: ${e}.`),this.bounds=e}raisePen(){return this.isLowered!==!0?Promise.resolve("Already raised."):(this.isLowered=!1,this.makePenRequest_({state:"up"}))}lowerPen(){return this.isLowered===!0?Promise.resolve("Already lowered."):(this.isLowered=!0,this.makePenRequest_({state:"draw"}))}setPosition(e,t){return this.makePenRequest_({x:e,y:t})}setPenHeight_(e){return this.makePenRequest_({state:e})}makePenRequest_(e){let s={method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)};return fetch(Q,s)}queueCommand(e,...t){let s=()=>(console.log(`Evaluating queued ${e.name} with ${t}.`),e.apply(this,t));this.commandQueue.push(s),console.log(`Queued up ${e.name}. Queue size: ${this.commandQueue.length}.`),this.commandQueue.length==1&&(console.log("Starting to evaluate command queue."),this.processCommandQueue_())}processCommandQueue_(){if(this.commandQueue.length==0){console.log("Command queue finished.");return}let e=this.commandQueue[0];e().then(t=>{this.commandQueue.splice(0,1),this.processCommandQueue_()})}}class J{constructor(){this.usedRects=[]}clear(){this.usedRects=[]}addRect(e){this.usedRects.push(e)}getFreeRect(e){for(;;){let t=Math.random()*(1-e.width),s=Math.random()*(1-e.height),n=new w(t,s,e.width,e.height),i=!0;for(let r of this.usedRects)if(r.intersects(n)){i=!1;break}if(i)return n}}}const G=.05,X=10,j={fontName:"cursive"};class K extends k.EventEmitter{constructor(e=j){super(),this.fontName=e.fontName,O("hersheytext.json").then(t=>{console.log("Loaded fonts.",t),this.fonts=t,this.emit("ready")})}getStrokes(e){let t=[],s=this.fonts[this.fontName],n=0,i=0;for(let r=0;r<e.length;r++){let o=e[r],a=e.charCodeAt(r)-33,l=s.chars[a];if(o==" "){i+=X;continue}if(!l){console.warn(`No glyph found for character "${o}" in font
            ${this.fontName}.`);continue}let c=V(l.d),f=c[c.length-1][2],g=f[f.length-1];for(let p of c)for(let v=0;v<p[2].length;v++)p[2][v]+=n,p[0][v]+=i;let d=$(c);for(let p of c)t.push(p);n+=g,i+=d.width}return t}}function V(h){let e=0,t=[],s=h.split("M");for(let n of s){if(n=="")continue;let i=n.split(/L| /),r=[],o=[],a=[];for(let l of i){if(l=="")continue;let c=l.split(","),u=parseFloat(c[0]),f=parseFloat(c[1]);r.push(u),o.push(f),a.push(e),e+=G*1e3}t.push([r,o,a])}return t}window.SpeechRecognition=window.webkitSpeechRecognition||window.SpeechRecognition;const z=[{name:"repeat",synonyms:["again","more","another"]},{name:"random",synonyms:["anything","something"]}];class Y extends k.EventEmitter{constructor(){super(),console.log("hi");var e=new window.SpeechRecognition;e.continuous=!0,e.interimResults=!0,e.addEventListener("result",this.onResult.bind(this)),e.addEventListener("start",this.onStart.bind(this)),e.addEventListener("end",this.onEnd.bind(this)),this.recognition=e,this.labels=[],this.isRunning=!1,this.isSomeoneSpeaking=!1,this.isPaused=!1}start(){this.isRunning||(console.log("Starting speech recognition."),this.recognition.start())}pause(){this.isPaused=!0}resume(){this.isPaused=!1}setLabels(e){this.labels=e}onStart(){this.isRunning=!0,this.emit("start")}onResult(e){if(this.isPaused)return;let t=-1/0,s=null,n=e.results[e.results.length-1];for(let i of n){this.isSomeoneSpeaking||(this.emit("listening"),this.isSomeoneSpeaking=!0);let r=i.transcript.toLowerCase(),o=r.trim().split(" "),a=i.confidence;console.log("Speech alternative",i);for(let l of z){let c=Z(l);for(let u of c)if(o.indexOf(u)!=-1){this.emitResult({value:l.name,type:"command"});return}}for(let l of this.labels)l.split(" ").length>1?r.indexOf(l)!=-1&&a>t&&(t=a,s=l):o.indexOf(l)!=-1&&a>t&&(t=a,s=l)}s&&this.emitResult({value:s,type:"label"})}emitResult(e){this.emit("result",e),this.emit("idle"),this.isSomeoneSpeaking=!1}onEnd(e){console.log("onEnd_",e),this.isRunning=!1,this.start()}}function Z(h){let e=h.synonyms.slice(0);return e.push(h.name),e}class T extends k.EventEmitter{constructor(e){super(),this.renderers=e.renderers,this.isPerfectPlayback=e.isPerfectPlayback,this.currentTime=0,this.isPlaying=!1,this.lastTimestamp=null,this.playbackSpeed=e.playbackSpeed||1}clear(){for(let e of this.renderers)e.clear()}load(e,t=new w(0,0,1,1)){this.strokes=e,this.duration=this.calculateDuration(),this.bounds=$(e);let s=this.bounds.width/this.bounds.height,n=w.copy(t),i=n.width/n.height;if(s>i){let r=i/s*n.height,o=n.height-r;n.y+=o/2,n.height=r}else{let r=s/i*n.width,o=n.width-r;n.x+=o/2,n.width=r}for(let r of this.renderers)r.setTargetRect(n)}start(){this.currentTime=0,this.isPlaying=!0,this.lastTimestamp=null,this.requestId=requestAnimationFrame(this.loop.bind(this)),this.emit("start")}stop(){this.isPlaying=!1,this.currentTime=0,cancelAnimationFrame(this.requestId)}calculateDuration(){let e=this.strokes.map(t=>{let s=t[2];return s[s.length-1]});return ee(e)/1e3}loop(e){if(!this.lastTimestamp){this.lastTimestamp=e,this.requestId=requestAnimationFrame(this.loop.bind(this));return}let t=(e-this.lastTimestamp)/1e3,s=this.currentTime,n=s+t*this.playbackSpeed;if(this.currentTime>this.duration){for(let r of this.renderers)r.finish();this.stop(),this.emit("end");return}let i=null;if(this.isPerfectPlayback?i=this.getLinesBetween(s,n,!0):i=this.getCompleteLinesBetween(s,n,!0),i.length>0)for(let r of this.renderers)r.renderLines(i);this.isPlaying&&(this.requestId=requestAnimationFrame(this.loop.bind(this))),this.lastTimestamp=e,this.currentTime=n}getLinesBetween(e,t,s=!1){let n=[];for(let i of this.strokes){let r=i[0],o=i[1],a=i[2],l=[],c;for(c=0;c<r.length;c++){let u=r[c],f=o[c],g=a[c]/1e3;if(e<=g&&g<=t){let d=r[c+1],p=o[c+1];s&&(u=(u-this.bounds.x)/this.bounds.width,f=(f-this.bounds.y)/this.bounds.height,d=(d-this.bounds.x)/this.bounds.width,p=(p-this.bounds.y)/this.bounds.height),l.push(new S(u,f)),l.push(new S(d,p))}}l.length!=0&&n.push(l)}return n}getCompleteLinesBetween(e,t,s=!1){let n=[];for(let i of this.strokes){let r=i[2],o=r[0]/1e3;if(e<=o&&o<=t){let a=[];for(let l=0;l<r.length;l++){let c=i[0][l],u=i[1][l];s&&(c=(c-this.bounds.x)/this.bounds.width,u=(u-this.bounds.y)/this.bounds.height),a.push({x:c,y:u})}n.push(a)}}return n}}function ee(h){let e=-1/0;for(let t of h)t>e&&(e=t);return e}class te extends k.EventEmitter{constructor(e){super(),this.selector=e,this.el=document.querySelector(this.selector),this.canvasRenderer=new M(`${this.selector} .mic-body`),this.canvasRenderer.setStrokeStyle("blue");let t=`${this.selector} .mic-level`;this.levelCanvas=document.querySelector(t)}create(e,t){this.el.style.display="block",this.levelPoints=t;let s=new T({renderers:[this.canvasRenderer],playbackSpeed:3,isPerfectPlayback:!0});s.load(e),s.start(),s.on("end",this.onMicrophoneCreated.bind(this))}setListening(e){e?(this.el.classList.add("listening"),this.el.classList.remove("busy")):(this.el.classList.remove("listening"),this.el.classList.add("busy"))}onMicrophoneCreated(){this.emit("created"),this.loop()}loop(){let e=this.levelCanvas.getContext("2d"),t=this.levelCanvas.width,s=this.levelCanvas.height,n=this.levelPoints[0].y;e.clearRect(0,0,t,s),e.lineCap="round",e.lineWidth=2,e.strokeStyle="black";const i=new Date().valueOf()/200,r=[.01,.02];let o=r[0]+(1+Math.sin(i))*r[1],a=this.getSineWave([this.levelPoints[0].x,this.levelPoints[1].x],o);e.beginPath();for(let l=0;l<a.length-1;l++){let c=a[l],u=a[l+1];e.moveTo(c.x*t,(c.y+n)*s),e.lineTo(u.x*t,(u.y+n)*s)}e.stroke(),requestAnimationFrame(this.loop.bind(this))}getSineWave(e,t){const s=new Date().valueOf()/3e3,n=50,i=e[1]-e[0],r=6;let o=[];for(let a=0;a<n;a++){let l=e[0]+a/n*i,c=l+s,u=Math.sin(c*2*Math.PI/i*r)*t;o.push(new S(l,u))}return o}}const se="sketches",ne=["The","animal migration"],ie=["asparagus","bus","cactus","compass","hourglass","octopus","rhinoceros","glass"],re=["a","e","i","o","u"];class oe{constructor(e){this.labelUrl=e,this.lastLabel=null}load(){return O(this.labelUrl).then(e=>(this.labels=e,e))}getRandomSketch(e="",t=null){e||(e=this.getRandomLabel()),this.lastLabel=e;let s=`${se}/${e}.ndjson`;return O(s,!0).then(n=>(t==null?D(n):n[t]).drawing)}getLabels(){return this.labels}getRandomLabel(){return D(this.labels)}getLastLabel(){return this.lastLabel}getLastArticle(){let e=this.lastLabel;if(!e)return"";for(let s of ne)if(e.startsWith(s))return"";for(let s of ie){let n=e[e.length-1];if(!e.endsWith(s)&&n=="s")return""}let t=e[0];return re.indexOf(t)>=0?"an":"a"}}class le extends k.EventEmitter{constructor(e){super(),this.selector=e,this.canvasRenderer=new M(this.selector),this.canvasRenderer.setStrokeStyle("red")}create(e,t){this.penOrigin=t;let s=new T({renderers:[this.canvasRenderer],playbackSpeed:3,isPerfectPlayback:!0});s.load(e),s.start(),s.on("end",()=>{this.emit("created")})}setPosition(e,t){let s=this.canvasRenderer.getCanvasElement();s.style.position="absolute";let n=-this.penOrigin.x*s.offsetWidth,i=-this.penOrigin.y*s.offsetHeight,r=e.x+t.offsetLeft+n,o=e.y+t.offsetTop+i;s.style.left=`${r}px`,s.style.top=`${o}px`}setDrawingState(e){let t=this.canvasRenderer.getCanvasElement();e?t.classList.add("drawing"):t.classList.remove("drawing")}}const ae=[5,10];class he extends k.EventEmitter{constructor(){super()}setState(e){this.currentState!=e&&(document.querySelector("#status-code").innerHTML=e,e=="idle"?this.startBoredom():this.stopBoredom(),this.currentState=e,this.emit("stateChange",this.currentState))}getState(){return this.currentState}startBoredom(){this.stopBoredom(),this.boredomTimer=window.setTimeout(this.drawDoodle.bind(this),this.getBoredomDelay()*1e3)}drawDoodle(){this.setState("bored"),this.emit("doodle"),this.stopBoredom(),this.boredomTimer=window.setTimeout(this.drawDoodle.bind(this),this.getBoredomDelay()*1e3)}stopBoredom(){clearTimeout(this.boredomTimer)}getBoredomDelay(){let[e,t]=ae,s=e+Math.random()*(t-e);return console.log(`getBoredomDelay: ${s}.`),s}}const q=new w(.1,.1,.8,.6),I=new w(.2,.8,.6,.08),ce=new w(.95,.02,.03,.03),ue=["zigzag","squiggle","line","snowflake","animal migration"],de=new S(.8,1),fe=[new S(.25,.18),new S(.6,.18)];let b=null,y=null,x=null,A=new K,E=new te("#microphone"),L=new le("canvas#pencil"),R=new he,_=new J;function me(){R.setState("inactive"),b=new oe("labels.json"),b.load().then(e=>{console.log("Loaded labels."),x.setLabels(b.getLabels())});let h=new M("canvas#display");if(ge("drawbot")){let e=new H({canvasDimensions:{width:138,height:67}});y=new T({renderers:[e,h],playbackSpeed:1,isPerfectPlayback:!1}),new W({selector:"#controls",renderer:e})}else b.getRandomSketch("pencil",0).then(e=>{L.create(e,de)}),L.on("created",()=>{document.querySelector("button").style.visibility="visible"}),y=new T({renderers:[h],playbackSpeed:2,isPerfectPlayback:!0}),h.on("position",e=>{L.setPosition(e,h.getCanvasElement())}),h.on("up",()=>{L.setDrawingState(!1)}),h.on("down",()=>{L.setDrawingState(!0)});x=new Y,x.on("start",e=>{R.setState("idle")}),x.on("listening",e=>{R.setState("listening")}),x.on("result",e=>{e.type=="command"?e.value=="repeat"?C(b.getLastLabel()):e.value=="random"&&C(b.getRandomLabel()):e.type=="label"&&C(e.value)}),window.addEventListener("click",B),R.on("stateChange",e=>{console.log("StateMachine stateChange: ",e),e=="idle"?E.setListening(!0):e=="drawing"&&E.setListening(!1)}),R.on("doodle",()=>{ye()})}function B(){window.removeEventListener("click",B);let h=E.canvasRenderer;h.on("position",e=>{L.setPosition(e,h.getCanvasElement())}),h.on("up",()=>{L.setDrawingState(!1)}),h.on("down",()=>{L.setDrawingState(!0)}),b.getRandomSketch("microphone",23).then(e=>{E.create(e,fe)}),E.on("created",()=>{x.start()}),document.querySelector("canvas#display").style.display="inline",document.querySelector("#begin").style.display="none",window.addEventListener("click",pe)}function pe(){let h=R.getState();(h=="idle"||h=="bored")&&C(null)}function C(h){y.clear(),_.clear(),_.addRect(q),_.addRect(I),b.getRandomSketch(h).then(e=>{y.load(e,q),y.start(),x.pause(),R.setState("drawing"),y.once("end",()=>{let t=b.getLastLabel(),s=A.getStrokes(t);console.log(`Using ${s.length} strokes to render "${t}".`),y.load(s,I),y.start(),y.once("end",()=>{R.setState("idle"),x.resume();let n=A.getStrokes("?");y.load(n,ce),y.start()})})})}function ge(h){h=h.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+h+"=([^&#]*)"),t=e.exec(location.search);return t===null?"":decodeURIComponent(t[1].replace(/\+/g," "))}function ye(){let h=_.getFreeRect({width:.05,height:.05});_.addRect(h),b.getRandomSketch(D(ue)).then(e=>{y.load(e,h),y.start()})}window.addEventListener("load",me);
